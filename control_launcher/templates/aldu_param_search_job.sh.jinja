#!/bin/bash

{# Parameters for the job scheduler SLURM, see https://support.ceci-hpc.be/doc/_contents/QuickStart/SubmittingJobs/SlurmTutorial.html -#}
#SBATCH --output=slurm_output_%a.log
#SBATCH --job-name={{ source_name }}_{{ transition }}_{{ config_name }}
#SBATCH --mail-user={{ user_email }}
#SBATCH --mail-type={{ mail_type }}
#SBATCH --time={{ job_walltime }}
#SBATCH --ntasks=1
#SBATCH --mem-per-cpu={{ job_memory }}
{% if partition != None -%}
#SBATCH --partition={{ partition }}
{%- endif %}
#SBATCH --array=0-{{ array_size }}

echo -e "******************************************************************************"
echo -e "**************************   Beginning of the job   **************************"
echo -e "******************************************************************************\n"

date
cd "${SLURM_SUBMIT_DIR}"

# Define the QOCT-RA directory here
QOCT_RA_DIR="${CECIHOME}/QOCT-RA"

echo -e "\n============================================================================="
echo -e "=====================   Defining the parameters files   ====================="
echo -e "=============================================================================\n"

# Load the file containing the input filenames

param_files=($(<{{ input_names }}))

# Define the names of the input file for this specific job

param_nml="${param_files[${SLURM_ARRAY_TASK_ID}]}"

echo -e "The parameters file for this job is ${param_nml}"

# Cut beginning and end of the input file name to define the base of the subdirectory name (see https://stackoverflow.com/questions/19482123/extract-part-of-a-string-using-bash-cut-split)

no_prefix="${param_nml#{{ prefix_param }}}"
base_subdirname="${no_prefix%.nml}"

# Create the subdirectory where the files of this job will be stored afterwards

if [ "${SLURM_ARRAY_TASK_ID}" -lt 10 ]
then
  subdirname="00${SLURM_ARRAY_TASK_ID}_${base_subdirname}"
elif [ "${SLURM_ARRAY_TASK_ID}" -ge 10 ] && [ "${SLURM_ARRAY_TASK_ID}" -lt 100 ]
then
  subdirname="0${SLURM_ARRAY_TASK_ID}_${base_subdirname}"
else
  subdirname="${SLURM_ARRAY_TASK_ID}_${base_subdirname}"
fi

echo -e "Creating subdirectory ${subdirname} in the ${SLURM_SUBMIT_DIR} to host all the files specific to this job"
mkdir -p "${SLURM_SUBMIT_DIR}/${subdirname}"

echo -e "\n======================================================================="
echo -e "=========================   Running QOCT-RA   ========================="
echo -e "=======================================================================\n"

# A temporary directory (SCRATCH) is created on the node where the job is running, for handling temporary files. 
# See https://support.ceci-hpc.be/doc/_contents/SubmittingJobs/SlurmFAQ.html#q11-how-do-i-use-the-local-scratch-space for more details.

SCRATCH="${LOCALSCRATCH}/${SLURM_JOB_ID}"

echo -e "Creating temporary directory ${SCRATCH} on node(s) ${SLURM_JOB_NODELIST} from ${CLUSTER_NAME} cluster for handling temporary files."

mkdir -p "${SCRATCH}" || exit $?

# Copy the input files to the scratch folder

cp "${SLURM_SUBMIT_DIR}/${param_nml}" "${SLURM_SUBMIT_DIR}/{{ rendered_param_PCP }}" "${SLURM_SUBMIT_DIR}/{{ guess_pulse }}" "${SCRATCH}/" || exit $?

cd "${SCRATCH}"
mkdir -p "Verif" # Strangely needed by QOCT-RA

# Load the necessary modules

{% for set_env_line in set_env -%}
{{ set_env_line }}
{% endfor %}

# Compile the code (cluster dependent)

echo -e ">>> Start of QOCT-RA compilation"
gfortran -lopenblas -O3 -march=native -ffast-math -funroll-loops -fwhole-program -flto -fexternal-blas -fdefault-integer-8 -m64 "${QOCT_RA_DIR}/fft_sub.f" "${QOCT_RA_DIR}/mymod.f" "${QOCT_RA_DIR}/Controle.f90" -o "Controle.out"
rm "mymod.mod"  
echo -e ">>> End of QOCT-RA compilation"

# First execution to get the optimal pulse

echo -e "\n================= First QOCT-RA execution begins now =================="
./Controle.out "${param_nml}" "${QOCT_RA_DIR}" || { rm -r ${SCRATCH}/Pulse/Pulse_iter* && cp -r ${SCRATCH}/* "${SLURM_SUBMIT_DIR}/${subdirname}" && echo "ERROR: A problem has occcured during the first execution of QOCT-RA" && exit $?; }
echo -e "\n================= First QOCT-RA execution ends now =================="

# Second execution to test the optimal pulse (PCP mode)

mkdir "${SCRATCH}/PCP"
mv "Controle.out" "${SCRATCH}/PCP/"
cd "${SCRATCH}/PCP/"

echo -e "\n================= PCP QOCT-RA execution begins now =================="
./Controle.out "${SCRATCH}/{{ rendered_param_PCP }}" "${QOCT_RA_DIR}" || { rm -r ${SCRATCH}/Pulse/Pulse_iter* && cp -r ${SCRATCH}/* "${SLURM_SUBMIT_DIR}/${subdirname}" && echo "ERROR: A problem has occcured during the PCP execution of QOCT-RA" && exit $?; }
rm "Controle.out"
echo -e "\n================= PCP QOCT-RA execution ends now =================="

echo -e "\nCopying output files to the submit directory."
rm -r ${SCRATCH}/Pulse/Pulse_iter*
cp -r ${SCRATCH}/* "${SLURM_SUBMIT_DIR}/${subdirname}"  || { echo "ERROR: Unable to copy SCRATCH directory in ${SLURM_SUBMIT_DIR}/${subdirname}" && exit $?; }

echo -e "\nRemoving ${SCRATCH} directory."
cd "${SLURM_SUBMIT_DIR}"
rm -rf "${SCRATCH}" || echo "ERROR: A problem might have occurred when trying to remove temporary files."

echo -e "\nMoving input file to its corresponding subdirectory."
mv "${param_nml}" "${subdirname}/"

{% if copy_files is sameas true -%}
echo -e "\n===================================================================="
echo -e "==============   Post-calculation files manipulation   ============="
echo -e "===================================================================="

# Copy data directory (only once, with the ARRAY_ID = 1)
if [ ${SLURM_ARRAY_TASK_ID} -eq 1 ]
then
  res_data_dir="{{ results_dir }}/{{ source_name }}/CONTROL/aldu_param_search"
  echo -e "\nCopying data files to ${res_data_dir}."
  mkdir -p "${res_data_dir}"
  cp -rf  "{{ data_dir }}" "${res_data_dir}"
fi

# Copy job files
dirname="{{ transition }}"
res_dir="{{ results_dir }}/{{ source_name }}/CONTROL/aldu_param_search/${dirname}"
mkdir -p "${res_dir}"
echo -e "\nCopying job files from ${dirname} to ${res_dir}."
if [ ${SLURM_ARRAY_TASK_ID} -eq 1 ]
then
cp "{{ rendered_param_PCP }}" "{{ guess_pulse }}" "{{ job_script }}" "{{ config_name }}.yml" "${res_dir}" # Copy those files only once as they are the same for each job in the array
fi
cp "${subdirname}/${param_nml}" "${res_dir}/${subdirname}_param.nml"
cp "${subdirname}/obj.res" "${res_dir}/${subdirname}_obj.res"
cp "${subdirname}/PCP/obj.res" "${res_dir}/${subdirname}_obj_PCP.res"

echo -e "\n******************************************************************************"
echo -e "*****************************   End of the job   *****************************"
echo -e "******************************************************************************"

# Copy slurm output file
cp "slurm_output_${SLURM_ARRAY_TASK_ID}.log" "${res_dir}/${subdirname}_slurm_output.log"
{% else %}
echo -e "\n******************************************************************************"
echo -e "*****************************   End of the job   *****************************"
echo -e "******************************************************************************"
{%- endif %}
# Move slurm output file to its corresponding subdirectory
mv "slurm_output_${SLURM_ARRAY_TASK_ID}.log" "${subdirname}/"
